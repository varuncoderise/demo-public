name: Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

env:
  DEFAULT_TAG: v1.0.0
  TIMEZONE: Asia/Kolkata
  BOT_NAME: coderiseio-bot
  BOT_EMAIL: coderiseio@bot.com
  REPO: ${{ github.repository }}

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: Calculate 3-Digit Version
        id: version
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Fetching tags"
          git fetch --tags --force
          LAST_TAG=$(git tag --sort=-v:refname | head -n1 || echo "${{ env.DEFAULT_TAG }}")
          echo "Latest tag: $LAST_TAG"

          if [[ ! "$LAST_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid LAST_TAG format: $LAST_TAG. Using DEFAULT_TAG."
            LAST_TAG="${{ env.DEFAULT_TAG }}"
          fi

          if git rev-parse "$LAST_TAG" >/dev/null 2>&1; then
            COMMIT_RANGE="${LAST_TAG}..HEAD"
          else
            echo "Initial release."
            echo "NEW_VERSION=$DEFAULT_TAG" >> $GITHUB_ENV
            echo "BARE_VERSION=${DEFAULT_TAG#v}" >> $GITHUB_ENV
            echo "RELEASE_TYPE=initial" >> $GITHUB_ENV
            echo "COMMIT_RANGE=HEAD" >> $GITHUB_ENV
            exit 0
          fi

          echo "Commit range: $COMMIT_RANGE"
          echo "COMMIT_RANGE=$COMMIT_RANGE" >> $GITHUB_ENV

          VERSION=${LAST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          CURRENT_VERSION=$(grep -i "Version:" servv.php | head -n1 | sed -E 's/.*Version:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          CURRENT_STABLE=$(grep -i "Stable tag:" readme.txt | head -n1 | sed -E 's/.*Stable tag:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*/\1/')

          PR_NUMBER=${{ github.event.pull_request.number }}
          LABELS=$(GH_TOKEN=${{ secrets.PAT_TOKEN }} gh pr view $PR_NUMBER --json labels --jq '.labels[].name')

          if echo "$LABELS" | grep -q "^release:major$"; then
            RELEASE_TYPE="major"; MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0; CHANGELOG_SECTION="Feature Release"; BREAKING_CHANGES="true"
          elif echo "$LABELS" | grep -q "^release:minor$"; then
            RELEASE_TYPE="minor"; MINOR=$((MINOR+1)); PATCH=0; CHANGELOG_SECTION="Feature Release"
          elif echo "$LABELS" | grep -q "^release:patch$"; then
            RELEASE_TYPE="patch"; PATCH=$((PATCH+1)); CHANGELOG_SECTION="Maintenance Release"
          elif echo "$LABELS" | grep -q "^release:hotfix$"; then
            RELEASE_TYPE="hotfix"; PATCH=$((PATCH+1)); CHANGELOG_SECTION="Hotfix Release"
          else
            RELEASE_TYPE="none"; CHANGELOG_SECTION="Maintenance Release"
          fi

          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV

          if [ "$RELEASE_TYPE" != "none" ]; then
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
            BARE_VERSION="$MAJOR.$MINOR.$PATCH"

            echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
            echo "BARE_VERSION=$BARE_VERSION" >> $GITHUB_ENV
            echo "CHANGELOG_SECTION=$CHANGELOG_SECTION" >> $GITHUB_ENV

            CHANGED=false
            if [ "$CURRENT_VERSION" != "$BARE_VERSION" ]; then
              sed -i "s/Version:.*/Version: $BARE_VERSION/" servv.php
              CHANGED=true
            fi
            if [ "$CURRENT_STABLE" != "$BARE_VERSION" ]; then
              sed -i "s/Stable tag:.*/Stable tag: $BARE_VERSION/" readme.txt
              CHANGED=true
            fi

            if [ "$CHANGED" = true ]; then
              git config user.name "${{ env.BOT_NAME }}"
              git config user.email "${{ env.BOT_EMAIL }}"
              git add servv.php readme.txt
              git commit -m "Update version and stable tag to $BARE_VERSION"

              git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ env.REPO }}.git

              # FIX: Allow bypass warning
              git push origin main || true
            fi
          fi

      - name: Generate Changelog
        if: env.NEW_VERSION != ''
        run: |
          echo "Generating changelog"

          # Generate commit messages from the commit range, excluding specific files
          COMMITS=$(git log ${{ env.COMMIT_RANGE }} --pretty=format:"%s (%h)" --no-merges -- . ':(exclude).github/*' ':(exclude)CHANGELOG.md' ':(exclude)readme.txt' ':(exclude)servv.php' | while read -r line; do
            # Remove leading dashes and trim whitespace
            cleaned=$(echo "$line" | sed 's/^[[:space:]]*-\+[[:space:]]*//')
            # Add single dash prefix
            echo "- $cleaned"
          done)
          
          # Save commits to environment variable for use in release notes
          echo "OTHER_COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          {
            echo "# ${{ env.NEW_VERSION }}"
            echo ""
            echo "${{ env.BARE_VERSION }} ($(TZ=${{ env.TIMEZONE }} date +%Y-%m-%d))"
            echo ""
            echo "## ${{ env.CHANGELOG_SECTION }}"
            echo ""
            echo "$COMMITS"
          } > changelog_temp.md

          if [[ -f CHANGELOG.md ]]; then
            echo "" >> changelog_temp.md
            cat CHANGELOG.md >> changelog_temp.md
          fi

          mv changelog_temp.md CHANGELOG.md

          git add CHANGELOG.md
          git config user.name "${{ env.BOT_NAME }}"
          git config user.email "${{ env.BOT_EMAIL }}"
          git commit -m "update changelog for ${{ env.NEW_VERSION }}"

          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ env.REPO }}.git

          # FIX: Allow bypass warning
          git push origin main || true

      - name: Create Source Code Zip
        if: env.NEW_VERSION != ''
        run: |
          REPO_NAME="servvai-event-booking"
          ZIP_NAME="${REPO_NAME}-${{ env.NEW_VERSION }}.zip"
          git archive --format=zip --output="${ZIP_NAME}" HEAD
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV

      - name: Create Tag and Release
        if: env.NEW_VERSION != ''
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config user.name "${{ env.BOT_NAME }}"
          git config user.email "${{ env.BOT_EMAIL }}"

          git tag -a "${{ env.NEW_VERSION }}" -m "release ${{ env.NEW_VERSION }}"

          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ env.REPO }}.git

          # FIX: Allow bypass warning on tag push
          git push origin "${{ env.NEW_VERSION }}" || true

          # Generate release notes
          RELEASE_NOTES=$(cat <<EOF
          ## ${{ env.CHANGELOG_SECTION }}
          
          ${{ env.OTHER_COMMITS }}
          EOF
          )

          gh release create "${{ env.NEW_VERSION }}" \
            --title "Release: ${{ env.NEW_VERSION }}" \
            --notes "$RELEASE_NOTES" \
            "${{ env.ZIP_NAME }}#Clean Package"
